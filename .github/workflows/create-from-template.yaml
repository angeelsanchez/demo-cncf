name: Create Repo from Template

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: 'Name for the new repository'
        required: true
        type: string

jobs:
  create:
    runs-on: ubuntu-latest
    steps:
      - name: Create repo from template
        env:
          GH_TOKEN: ${{ secrets.REPO_TOKEN }}
        run: |
          REPO_NAME="${{ inputs.repo_name }}"
          echo "Creating repo: $REPO_NAME"

          gh api repos/${{ github.repository }}/generate \
            -X POST \
            -f owner=${{ github.repository_owner }} \
            -f name="$REPO_NAME" \
            -f description="Landing page for Cloud Native Latam Summit" \
            -F private=false \
            -F include_all_branches=false

          echo "Repo created: https://github.com/${{ github.repository_owner }}/$REPO_NAME"

      - name: Clone and update placeholders
        env:
          GH_TOKEN: ${{ secrets.REPO_TOKEN }}
        run: |
          REPO_NAME="${{ inputs.repo_name }}"
          OWNER="${{ github.repository_owner }}"
          REPO_FULL="${OWNER}/${REPO_NAME}"

          sleep 5

          git clone "https://x-access-token:${GH_TOKEN}@github.com/${REPO_FULL}.git" new-repo
          cd new-repo

          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"

          echo "Replacing __APP_NAME__ with ${REPO_NAME}"
          echo "Replacing __REPO_FULL__ with ${REPO_FULL}"

          # Use | as delimiter to avoid issues with / in REPO_FULL
          find . -type f \( -name "*.yaml" -o -name "*.yml" -o -name "*.html" -o -name "*.json" \) | while read file; do
            sed -i "s|__APP_NAME__|${REPO_NAME}|g" "$file"
            sed -i "s|__REPO_FULL__|${REPO_FULL}|g" "$file"
          done

          echo "Files after replacement:"
          cat catalog-info.yaml | head -20

          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add -A
            git commit -m "chore: initialize from template with name ${REPO_NAME}"
            git push
            echo "Changes committed and pushed"
          fi

      - name: Register ArgoCD Application
        env:
          GH_TOKEN: ${{ secrets.REPO_TOKEN }}
        run: |
          REPO_NAME="${{ inputs.repo_name }}"
          OWNER="${{ github.repository_owner }}"
          REPO_FULL="${OWNER}/${REPO_NAME}"

          git clone "https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git" parent-repo
          cd parent-repo

          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"

          mkdir -p argocd-apps

          cat > argocd-apps/${REPO_NAME}.yaml << EOF
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: ${REPO_NAME}
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/${REPO_FULL}.git
    targetRevision: HEAD
    path: k8s
  destination:
    server: https://kubernetes.default.svc
    namespace: demo-apps
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
EOF

          git add argocd-apps/${REPO_NAME}.yaml
          git commit -m "feat: add ArgoCD application for ${REPO_NAME}"
          git push

      - name: Trigger build workflow
        env:
          GH_TOKEN: ${{ secrets.REPO_TOKEN }}
        run: |
          REPO_NAME="${{ inputs.repo_name }}"
          sleep 5
          gh api repos/${{ github.repository_owner }}/$REPO_NAME/dispatches \
            -X POST \
            -f event_type=build || true
