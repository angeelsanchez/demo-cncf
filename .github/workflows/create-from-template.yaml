name: Create Repo from Template

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: 'Name for the new repository'
        required: true
        type: string

jobs:
  create:
    runs-on: ubuntu-latest
    steps:
      - name: Create repo from template
        env:
          GH_TOKEN: ${{ secrets.REPO_TOKEN }}
        run: |
          REPO_NAME="${{ inputs.repo_name }}"
          echo "Creating repo: $REPO_NAME"

          gh api repos/${{ github.repository }}/generate \
            -X POST \
            -f owner=${{ github.repository_owner }} \
            -f name="$REPO_NAME" \
            -f description="Landing page for Cloud Native Latam Summit" \
            -F private=false \
            -F include_all_branches=false

          echo "Repo created: https://github.com/${{ github.repository_owner }}/$REPO_NAME"

      - name: Clone and update placeholders
        env:
          GH_TOKEN: ${{ secrets.REPO_TOKEN }}
        run: |
          REPO_NAME="${{ inputs.repo_name }}"
          OWNER="${{ github.repository_owner }}"
          REPO_FULL="${OWNER}/${REPO_NAME}"

          sleep 3

          git clone "https://x-access-token:${GH_TOKEN}@github.com/${REPO_FULL}.git" new-repo
          cd new-repo

          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"

          find . -type f \( -name "*.yaml" -o -name "*.yml" -o -name "*.html" -o -name "*.json" \) -exec sed -i "s/__APP_NAME__/${REPO_NAME}/g" {} \;
          find . -type f \( -name "*.yaml" -o -name "*.yml" -o -name "*.html" -o -name "*.json" \) -exec sed -i "s/__REPO_FULL__/${REPO_FULL//\//\\/}/g" {} \;

          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add -A
            git commit -m "chore: initialize from template with name ${REPO_NAME}"
            git push
          fi

      - name: Trigger build workflow
        env:
          GH_TOKEN: ${{ secrets.REPO_TOKEN }}
        run: |
          REPO_NAME="${{ inputs.repo_name }}"
          sleep 5
          gh api repos/${{ github.repository_owner }}/$REPO_NAME/dispatches \
            -X POST \
            -f event_type=build || true
